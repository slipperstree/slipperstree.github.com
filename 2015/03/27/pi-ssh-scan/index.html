<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SSH暴力扫描的防范手段 | Mango Love Carrot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="之前买了块树莓派在家里搭了一台服务器玩，为了在外面方便访问，在路由器给小pi设置成了DMZ主机，并开启了SSH服务。一直用的很开心。前几天偶然打开系统日志发现每天都有大量的SSH登录失败的log。">
<meta property="og:type" content="article">
<meta property="og:title" content="SSH暴力扫描的防范手段">
<meta property="og:url" content="http://blog.mangolovecarrot.net/2015/03/27/pi-ssh-scan/index.html">
<meta property="og:site_name" content="Mango Love Carrot">
<meta property="og:description" content="之前买了块树莓派在家里搭了一台服务器玩，为了在外面方便访问，在路由器给小pi设置成了DMZ主机，并开启了SSH服务。一直用的很开心。前几天偶然打开系统日志发现每天都有大量的SSH登录失败的log。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SSH暴力扫描的防范手段">
<meta name="twitter:description" content="之前买了块树莓派在家里搭了一台服务器玩，为了在外面方便访问，在路由器给小pi设置成了DMZ主机，并开启了SSH服务。一直用的很开心。前几天偶然打开系统日志发现每天都有大量的SSH登录失败的log。">
  
  
  <link href='//fonts.useso.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
  <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo"><i class="logo"></i><span class="site-title">Mango Love Carrot</span></a>
      <nav id="main-nav">
        
      </nav>
      <nav id="sub-nav">
        <div class="profile" id="profile-nav">
          <a id="profile-anchor" href="javascript:;"><img class="avatar" src="/"><i class="fa fa-caret-down"></i></a>
        </div>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="q" value="site:http://blog.mangolovecarrot.net"></form>
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
      
      <td>
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="q" value="site:http://blog.mangolovecarrot.net"></form>
      </td>
      </tr>
    </table>
  </div>
  
</header>
    <div class="outer">
      <aside id="profile">
  <div class="inner profile-inner">
  	<div class="base-info profile-block">
		  <img id="avatar" src="/">
      <h2 id="name">mango</h2>
      <h3 id="title">undefined</h3>
      <span id="location"><i class="fa fa-map-marker"></i>undefined</span>
      <a id="follow" href="undefined">关注我</a>
  	</div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        9
        <span>文章</span>
      </div>
      <div class="article-info-block">
        17
        <span>标签</span>
      </div>
    </div>
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
        
        </tr>
      </table>
    </div>
  </div>
</aside>
      <section id="main"><article id="post-pi-ssh-scan" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      SSH暴力扫描的防范手段
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/2015/03/27/pi-ssh-scan/">
    <time datetime="2015-03-27T10:47:37.000Z" itemprop="datePublished">3月 27 2015</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/技术/">技术</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前买了块树莓派在家里搭了一台服务器玩，为了在外面方便访问，在路由器给小pi设置成了DMZ主机，并开启了SSH服务。一直用的很开心。<br>前几天偶然打开系统日志发现每天都有大量的SSH登录失败的log。<br><a id="more"></a></p>
<h1 id="背景">背景</h1><p>之前买了一块树莓派在家里搭了一台服务器玩，为了在外面方便访问，在路由器给小pi设置成了DMZ主机，并开启了SSH服务。一直用的很开心。<br>前几天偶然打开系统日志发现每天都有大量的SSH登录失败的log。基本上长成下面这个样子：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">Mar</span> 26 09<span class="pseudo">:30</span><span class="pseudo">:39</span> <span class="tag">raspberrypi</span> <span class="tag">sshd</span><span class="attr_selector">[1088]</span>: <span class="tag">Failed</span> <span class="tag">password</span> <span class="tag">for</span> <span class="tag">root</span> <span class="tag">from</span> 115<span class="class">.230</span><span class="class">.126</span><span class="class">.148</span> <span class="tag">port</span> 34063 <span class="tag">ssh2</span></span><br><span class="line"><span class="tag">Mar</span> 26 09<span class="pseudo">:30</span><span class="pseudo">:42</span> <span class="tag">raspberrypi</span> <span class="tag">sshd</span><span class="attr_selector">[1088]</span>: <span class="tag">Failed</span> <span class="tag">password</span> <span class="tag">for</span> <span class="tag">root</span> <span class="tag">from</span> 115<span class="class">.230</span><span class="class">.126</span><span class="class">.148</span> <span class="tag">port</span> 34063 <span class="tag">ssh2</span></span><br><span class="line"><span class="tag">Mar</span> 26 09<span class="pseudo">:30</span><span class="pseudo">:57</span> <span class="tag">raspberrypi</span> <span class="tag">sshd</span><span class="attr_selector">[1251]</span>: <span class="tag">Failed</span> <span class="tag">password</span> <span class="tag">for</span> <span class="tag">root</span> <span class="tag">from</span> 115<span class="class">.230</span><span class="class">.126</span><span class="class">.148</span> <span class="tag">port</span> 40513 <span class="tag">ssh2</span></span><br><span class="line"><span class="tag">Mar</span> 26 09<span class="pseudo">:30</span><span class="pseudo">:58</span> <span class="tag">raspberrypi</span> <span class="tag">sshd</span><span class="attr_selector">[1255]</span>: <span class="tag">Failed</span> <span class="tag">password</span> <span class="tag">for</span> <span class="tag">invalid</span> <span class="tag">user</span> <span class="tag">user</span> <span class="tag">from</span> 111<span class="class">.73</span><span class="class">.46</span><span class="class">.22</span> <span class="tag">port</span> 4918 <span class="tag">ssh2</span></span><br><span class="line"><span class="tag">Mar</span> 26 09<span class="pseudo">:30</span><span class="pseudo">:59</span> <span class="tag">raspberrypi</span> <span class="tag">sshd</span><span class="attr_selector">[1251]</span>: <span class="tag">Failed</span> <span class="tag">password</span> <span class="tag">for</span> <span class="tag">root</span> <span class="tag">from</span> 115<span class="class">.230</span><span class="class">.126</span><span class="class">.148</span> <span class="tag">port</span> 40513 <span class="tag">ssh2</span></span><br><span class="line"><span class="tag">Mar</span> 26 09<span class="pseudo">:31</span><span class="pseudo">:01</span> <span class="tag">raspberrypi</span> <span class="tag">sshd</span><span class="attr_selector">[1251]</span>: <span class="tag">Failed</span> <span class="tag">password</span> <span class="tag">for</span> <span class="tag">root</span> <span class="tag">from</span> 115<span class="class">.230</span><span class="class">.126</span><span class="class">.148</span> <span class="tag">port</span> 40513 <span class="tag">ssh2</span></span><br><span class="line"><span class="tag">Mar</span> 26 09<span class="pseudo">:31</span><span class="pseudo">:10</span> <span class="tag">raspberrypi</span> <span class="tag">sshd</span><span class="attr_selector">[1370]</span>: <span class="tag">Failed</span> <span class="tag">password</span> <span class="tag">for</span> <span class="tag">invalid</span> <span class="tag">user</span> <span class="tag">ubnt</span> <span class="tag">from</span> 111<span class="class">.73</span><span class="class">.46</span><span class="class">.22</span> <span class="tag">port</span> 4432 <span class="tag">ssh2</span></span><br><span class="line"><span class="tag">Mar</span> 26 09<span class="pseudo">:31</span><span class="pseudo">:14</span> <span class="tag">raspberrypi</span> <span class="tag">sshd</span><span class="attr_selector">[1370]</span>: <span class="tag">Failed</span> <span class="tag">password</span> <span class="tag">for</span> <span class="tag">invalid</span> <span class="tag">user</span> <span class="tag">ubnt</span> <span class="tag">from</span> 111<span class="class">.73</span><span class="class">.46</span><span class="class">.22</span> <span class="tag">port</span> 4432 <span class="tag">ssh2</span></span><br><span class="line"><span class="tag">Mar</span> 26 09<span class="pseudo">:31</span><span class="pseudo">:19</span> <span class="tag">raspberrypi</span> <span class="tag">sshd</span><span class="attr_selector">[1370]</span>: <span class="tag">Failed</span> <span class="tag">password</span> <span class="tag">for</span> <span class="tag">invalid</span> <span class="tag">user</span> <span class="tag">ubnt</span> <span class="tag">from</span> 111<span class="class">.73</span><span class="class">.46</span><span class="class">.22</span> <span class="tag">port</span> 4432 <span class="tag">ssh2</span></span><br></pre></td></tr></table></figure></p>
<p>虽然对自己设置的密码强度有信心，但自己家里被人偷窥的感觉总是不爽。<br>解决方案有很多：</p>
<ul>
<li>被动方式。监视系统日志，发现有连续登录失败的尝试就屏蔽来源ip的请求，也就是封IP。</li>
<li>弱主动方式。修改SSH端口，SSH默认端口是22，改个端口可以档掉一部分扫描，但挡不住连端口也一起扫描的家伙。</li>
<li>强主动方式。关掉SSH的密码登录验证，只允许使用公密钥方式登录。这种方式最安全，缺点是初始设置稍微麻烦点，且用一个新的客户端总要进行初始设置。</li>
</ul>
<p>下面一个一个试着做。</p>
<h1 id="扫描系统日志，封IP">扫描系统日志，封IP</h1><p>系统日志的位置：<br>/var/log/auth.log</p>
<p>这个日志文件专门记录登入登出以及调用sudo等敏感操作。我们需要的尝试登录失败的记录就在里面。<br>我写了一个简单的shell程序。每一步都做了注释，应该很好懂。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span><br><span class="line"></span></span><br><span class="line"><span class="comment"># 日志文件</span></span><br><span class="line">LOG_FILE=<span class="string">"/var/log/auth.log"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上一次login失败的ip</span></span><br><span class="line">last_ip=<span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上一次列入黑名单的ip</span></span><br><span class="line">last_blocked_ip=<span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前处理行数</span></span><br><span class="line">lines=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每次运行时都删掉之前生成的ip列表文件</span></span><br><span class="line">rm -rf block_ip.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取错误日志总行数，以便输出处理进度</span></span><br><span class="line">total=<span class="string">"<span class="variable">$(grep "Failed" $&#123;LOG_FILE&#125; | wc -l)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检索错误日志，并逐行取得试图登录系统的ip</span></span><br><span class="line">grep <span class="string">"Failed"</span> <span class="variable">$LOG_FILE</span> | <span class="keyword">while</span> <span class="built_in">read</span> LINE; <span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment"># 从当前行取得ip</span></span><br><span class="line">  <span class="comment"># awk NF-3 的意思是以空格或tab为分隔符，从后往前数第3个项目</span></span><br><span class="line">  ip=<span class="string">"<span class="variable">$(echo $&#123;LINE&#125; | awk '&#123;print $(NF-3)</span>&#125;')"</span></span><br><span class="line">  lines=$((<span class="variable">$lines</span> + <span class="number">1</span>))</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 下面这条语句实现了显示进度的功能，注意最后是以\r结尾的，作用是不换行，把光标移动到行首</span></span><br><span class="line">  <span class="built_in">printf</span> <span class="string">"Progress Line: <span class="variable">$lines</span>"</span>/<span class="string">"<span class="variable">$total</span>\r"</span></span><br><span class="line">  <span class="comment">#echo $lines"/"$total</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 同一个IP连续两次登录错误的话就认为是恶意登录，将该ip记录到ip列表文件中</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$last_ip</span>"</span> == <span class="string">"<span class="variable">$ip</span>"</span> ] &amp;&amp; [ <span class="string">"<span class="variable">$ip</span>"</span> != <span class="string">"<span class="variable">$last_blocked_ip</span>"</span>   ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$ip</span>"</span> &gt;&gt; block_ip.log</span><br><span class="line">    last_blocked_ip=<span class="variable">$ip</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  last_ip=<span class="variable">$ip</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 至此，所有日志里试图连续尝试登录失败的ip全部被记录在*block_ip.log*这个文件中了。</span></span><br><span class="line"><span class="comment"># 接着我们把这个列表里重复的ip删掉</span></span><br><span class="line">sort block_ip.log | uniq &gt; sorted_ip.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这样我们就得到了一个不重复的，试图暴力破解我们密码的坏人的ip列表</span></span><br><span class="line"><span class="comment"># 屏蔽他们！</span></span><br><span class="line">cat sorted_ip.log | <span class="keyword">while</span> <span class="built_in">read</span> LINE; <span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  ip=<span class="variable">$&#123;LINE&#125;</span></span><br><span class="line">  <span class="comment"># 将ip加入黑名单</span></span><br><span class="line">  iptables -A INPUT <span class="operator">-s</span> <span class="string">"<span class="variable">$ip</span>"</span> -j DROP</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>这样，封ip就成功了。<br>这个程序还可以改成使用 tail -f 不停监视最新的日志，随时封新发现的ip的模式。有兴趣的可以自己动手改一下。</p>
<h1 id="修改SSH端口">修改SSH端口</h1><p>todo</p>
<h1 id="关掉SSH的密码登录验证">关掉SSH的密码登录验证</h1><p>todo</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.mangolovecarrot.net/2015/03/27/pi-ssh-scan/" data-id="ci8svpobo000dtfyq88th2ilr" class="article-share-link">分享到</a>
      
        <a href="http://blog.mangolovecarrot.net/2015/03/27/pi-ssh-scan/#ds-thread" class="article-comment-link">评论</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LINUX/">LINUX</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SSH/">SSH</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/树莓派/">树莓派</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/04/20/raspi-study01/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          用树莓派搭电子积木入门篇01
        
      </div>
    </a>
  
  
    <a href="/2015/03/24/chinease/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">《 中国人的撕扯人生：一边是上流，一边是逐流 》</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <div id="ds-thread" class="ds-thread" data-thread-key="http://blog.mangolovecarrot.net/2015/03/27/pi-ssh-scan/" data-title="SSH暴力扫描的防范手段" data-url="http://blog.mangolovecarrot.net/2015/03/27/pi-ssh-scan/">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by DuoShuo.</a></noscript>
      </div>
  </section>
</section>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 mango<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<script type="text/javascript">
  var duoshuoQuery = {short_name:"mangolovecarrot"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>


<script src="//ajax.useso.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>